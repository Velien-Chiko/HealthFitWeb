@model IEnumerable<HealthFit.Models.Product>
@using HealthFit.Models
@using HealthFit.Models.Constants
@{
    // Khai báo tiêu đề và layout cho trang quản lý sản phẩm của Seller
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Areas/Seller/Views/Shared/_Layout.cshtml";
    // Đã bỏ biến cho selected, dùng trực tiếp selected="@(condition)" trong <option>
}
<link rel="stylesheet" href="/css/seller-custom.css" />
<div class="container mt-5">
    <!-- Thanh điều hướng cho Seller -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold">Seller Menu</span>
            <div class="navbar-nav">
                <a class="nav-link" asp-controller="Seller" asp-action="Dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link" asp-controller="Seller" asp-action="EditProfile">
                    <i class="fas fa-user-edit"></i> Cập nhật thông tin
                </a>
                <a class="nav-link active" asp-controller="Seller" asp-action="ProductList">
                    <i class="fas fa-box"></i> Quản lý sản phẩm
                </a>
                <a class="nav-link" asp-controller="Seller" asp-action="OrderList">
                    <i class="fas fa-shopping-cart"></i> Quản lý đơn hàng
                </a>
            </div>
        </div>
    </nav>
    
    <h2 class="mb-4 text-center">Quản lý sản phẩm</h2>
    
    @* Hiển thị thông báo thành công/thất bại *@
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    <!-- Form tìm kiếm, lọc và sắp xếp sản phẩm -->
    <form class="row g-2 align-items-end mb-3 flex-nowrap flex-md-wrap" method="get" asp-action="ProductList" style="overflow-x:auto;">
        <div class="col-auto flex-grow-1" style="min-width:180px;">
            <input type="text" name="search" class="form-control" placeholder="Tìm kiếm theo tên sản phẩm..." value="@ViewBag.Search" />
        </div>
        <div class="col-auto" style="min-width:160px;">
            <select name="filter" class="form-select">
                <option value="">-- Tất cả trạng thái --</option>
                <option value="Pending" selected="@(ViewBag.Filter == "Pending")">Chờ duyệt</option>
                <option value="Approved" selected="@(ViewBag.Filter == "Approved")">Đã duyệt</option>
                <option value="Rejected" selected="@(ViewBag.Filter == "Rejected")">Từ chối</option>
            </select>
        </div>
        <div class="col-auto" style="min-width:140px;">
            <select name="sort" class="form-select">
                <option value="" selected="@(string.IsNullOrEmpty(ViewBag.Sort))">-- Sắp xếp --</option>
                <option value="price_asc" selected="@(ViewBag.Sort == "price_asc")">Giá tăng dần</option>
                <option value="price_desc" selected="@(ViewBag.Sort == "price_desc")">Giá giảm dần</option>
                <option value="quantity_asc" selected="@(ViewBag.Sort == "quantity_asc")">Số lượng tăng dần</option>
                <option value="quantity_desc" selected="@(ViewBag.Sort == "quantity_desc")">Số lượng giảm dần</option>
            </select>
        </div>
        <div class="col-auto d-flex gap-2" style="min-width:120px;">
            <button type="submit" class="btn btn-primary btn-sm seller-search-btn px-3"><i class="fas fa-search"></i> <span class="d-none d-md-inline">Tìm kiếm</span></button>
            <a class="btn btn-outline-primary btn-sm px-3 ms-1" asp-action="ProductList">Làm mới</a>
        </div>
    </form>
    <!-- Bảng danh sách sản phẩm -->
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Hình ảnh</th>
                <th>Tên sản phẩm</th>
                <th>Mô tả</th>
                <th>Giá</th>
                <th>Số lượng</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @* Hiển thị từng sản phẩm trong Model *@
            @if (Model != null)
            {
                int stt = 1;
                foreach (var item in Model)
                {
                    <tr>
                        <td>@(stt++)</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <img src="@item.ImageUrl" alt="@item.Name" style="width: 80px; height: 80px; object-fit: cover;" class="rounded" />
                            }
                            else
                            {
                                <div class="bg-light d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            }
                        </td>
                        <td>@item.Name</td>
                        <td>@(item.Description?.Length > 50 ? item.Description.Substring(0, 50) + "..." : item.Description)</td>
                        <td>@item.Price.ToString("N0") ₫</td>
                        <td>@item.Quantity</td>
                        <td>
                            @if (item.IsActive == ProductStatusConstants.Approved)
                            {
                                <span class="badge bg-success">Đã duyệt</span>
                            }
                            else if (item.IsActive == ProductStatusConstants.Pending)
                            {
                                <span class="badge bg-warning text-dark">Đang chờ duyệt</span>
                            }
                            else if (item.IsActive == ProductStatusConstants.Rejected)
                            {
                                <span class="badge bg-danger">Bị từ chối</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">@item.IsActive</span>
                            }
                        </td>
                        <td>
                            <a class="btn btn-sm btn-primary" asp-controller="Seller" asp-action="EditProduct" asp-route-id="@item.ProductId">
                                <i class="fas fa-edit"></i> Sửa
                            </a>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
    <!-- Phân trang danh sách sản phẩm -->
    @{
        var pager = ViewBag.Pager as HealthFit.Models.Models.Pager;
        string search = ViewBag.Search as string ?? "";
        string filter = ViewBag.Filter as string ?? "";
        string sort = ViewBag.Sort as string ?? "";
    }
    @if (pager != null && pager.TotalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                @if (pager.CurrentPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="ProductList" asp-route-pg="1" asp-route-search="@search" asp-route-filter="@filter" asp-route-sort="@sort">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" asp-action="ProductList" asp-route-pg="@(pager.CurrentPage - 1)" asp-route-search="@search" asp-route-filter="@filter" asp-route-sort="@sort">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                }
                @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                {
                    <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                        <a class="page-link" asp-action="ProductList" asp-route-pg="@pge" asp-route-search="@search" asp-route-filter="@filter" asp-route-sort="@sort">@pge</a>
                    </li>
                }
                @if (pager.CurrentPage < pager.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="ProductList" asp-route-pg="@(pager.CurrentPage + 1)" asp-route-search="@search" asp-route-filter="@filter" asp-route-sort="@sort">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" asp-action="ProductList" asp-route-pg="@(pager.TotalPages)" asp-route-search="@search" asp-route-filter="@filter" asp-route-sort="@sort">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

<!-- Script xác nhận xóa sản phẩm (nếu có chức năng xóa) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteForms = document.querySelectorAll('.delete-form');
    deleteForms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            const productName = this.getAttribute('data-product-name');
            if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm "' + productName + '"?')) {
                e.preventDefault();
            }
        });
    });
});
</script>