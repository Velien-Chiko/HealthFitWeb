@model IEnumerable<dynamic> //danh sách user
@using HealthFit.Models.Models;

@{
    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }

    ViewData["Title"] = "Danh Sách Người Dùng";
    var roleCounts = (Dictionary<string, int>)ViewBag.RoleCounts ?? new Dictionary<string, int>();//Lấy số lượng user theo từng vai trò
}

<style>
    .stat-header-box {
        background-color: #f0f9ff;
        border-left: 5px solid #0ea5e9;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        font-weight: 600;
        color: #0c4a6e;
    }

    .user-table {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    .table-wrapper {
        overflow-y: auto;
        max-height: calc(100vh - 400px);
    }
</style>

@* ============================= *@
@* THỐNG KÊ SỐ LƯỢNG USER THEO VAI TRÒ *@
@* Hiển thị số lượng user cho từng role (Admin, Manager, Nutri, Seller, Customer, ...) *@
@* ============================= *@
<div class="stat-header-box mb-3">
    <h5 class="m-0"><i class="bi bi-bar-chart-fill me-2"></i>Thống kê theo Vai Trò</h5>
</div>

        <div class="d-flex flex-wrap justify-content-between gap-3 mb-4">
            @if (roleCounts != null && roleCounts.Any())
            {
                foreach (var role in roleCounts)
                {
                    var bgColor = "bg-primary";
                    if (role.Key.ToLower().Contains("admin")) bgColor = "bg-danger";
                    else if (role.Key.ToLower().Contains("customer") || role.Key.ToLower().Contains("user")) bgColor = "bg-success";
                    else if (role.Key.ToLower().Contains("mod") || role.Key.ToLower().Contains("manager")) bgColor = "bg-warning text-dark";
                    else if (role.Key.ToLower().Contains("seller")) bgColor = "bg-info text-dark";
                    else if (role.Key.ToLower().Contains("nutri")) bgColor = "bg-secondary";

                    <div class="flex-fill" style="min-width: 180px; max-width: 200px;">
                        <div class="card text-white @bgColor h-100">
                            <div class="card-body text-center">
                                <h6 class="card-title">@role.Key</h6>
                                <p class="card-text fs-4 fw-bold">@role.Value</p>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-info w-100">
                    <i class="bi bi-info-circle"></i> Chưa có dữ liệu về vai trò người dùng.
                </div>
            }
        </div>

@* ============================= *@
@* FORM TÌM KIẾM, LỌC, SẮP XẾP, THÊM MỚI USER *@
@* - Tìm kiếm theo tên/email
   - Lọc theo vai trò
   - Sắp xếp theo vai trò
   - Thêm mới user *@
@* ============================= *@
        <!-- Thanh tìm kiếm + nút -->
        <div class="row mb-4">
            <div class="col-12">
                <form method="get" asp-area="SystemAdmin" asp-controller="ManagerRole" asp-action="SystemAdmin" class="d-flex flex-wrap gap-3 align-items-center">
                    <!-- Tìm kiếm theo email hoặc tên -->
                    <div class="flex-grow-1" style="min-width: 300px; max-width: 400px;">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="search"
                                   name="searchString"
                                   placeholder="Tìm theo tên hoặc email..."
                                   value="@ViewData["SearchString"]"
                                   class="form-control" />
                        </div>
                    </div>

                    <!-- Nút tìm kiếm và thêm mới -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Tìm kiếm
                        </button>

                        <!-- Lọc theo vai trò -->
                        <div style="min-width: 200px;">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-person-badge"></i>
                                </span>
                                <select name="roleFilter" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Chọn vai trò --</option>
                                    @foreach (var role in ViewBag.AvailableRoles)
                                    {
                                        if (!role.ToLower().Contains("admin"))
                                        {
                                            <option value="@role" selected="@(role == (string)ViewData["RoleFilter"])">@role</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Nút sắp xếp -->
                        @{
                            var sortOrder = (string)ViewData["CurrentSort"];
                            var nextSort = string.IsNullOrEmpty(sortOrder) || sortOrder == "role_desc" ? "role_asc" : "role_desc";
                        }
                        <a asp-area="SystemAdmin" asp-controller="ManagerRole" asp-action="SystemAdmin"
                           asp-route-sortOrder="@nextSort"
                           asp-route-searchString="@ViewData["SearchString"]"
                           asp-route-roleFilter="@ViewData["RoleFilter"]"
                           class="btn btn-info">
                            <i class="bi bi-sort-alpha-down"></i>
                            @if (sortOrder == "role_asc")
                            {
                                <span>Sắp xếp Z-A</span>
                            }
                            else
                            {
                                <span>Sắp xếp A-Z</span>
                            }
                        </a>

                        <!-- Nút quay lại -->
                        @if (!string.IsNullOrEmpty((string)ViewData["SearchString"]) || !string.IsNullOrEmpty((string)ViewData["RoleFilter"]))
                        {
                            <a asp-area="SystemAdmin" asp-controller="ManagerRole" asp-action="SystemAdmin" class="btn btn-secondary">
                                <i class="bi bi-arrow-counterclockwise"></i> Quay lại
                            </a>
                        }

                        <a asp-area="SystemAdmin" asp-controller="ManagerRole" asp-action="Create" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Thêm mới
                        </a>
                    </div>
                </form>
            </div>
        </div>

@* ============================= *@
@* BẢNG DANH SÁCH NGƯỜI DÙNG *@
@* Hiển thị danh sách user, thông tin, vai trò, các nút cập nhật/xóa *@
@* ============================= *@
        @if ((!string.IsNullOrEmpty((string)ViewData["SearchString"]) || !string.IsNullOrEmpty((string)ViewData["RoleFilter"])) && !Model.Any())
        {
            <div class="aler,t alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                @if (!string.IsNullOrEmpty((string)ViewData["SearchString"]) && !string.IsNullOrEmpty((string)ViewData["RoleFilter"]))
                {
                    <span>Không tìm thấy người dùng nào với từ khóa "@ViewData["SearchString"]" và vai trò "@ViewData["RoleFilter"]"</span>
                }
                else if (!string.IsNullOrEmpty((string)ViewData["SearchString"]))
                {
                    <span>Không tìm thấy người dùng nào với từ khóa "@ViewData["SearchString"]"</span>
                }
                else
                {
                    <span>Không tìm thấy người dùng nào với vai trò "@ViewData["RoleFilter"]"</span>
                }
            </div>
        }

        <!-- Bảng danh sách người dùng -->
        <div class="card user-table">
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="text-center">#</th>
                                <th scope="col">
                                    <i class="bi bi-person-badge me-1"></i>Thông tin
                                </th>
                                <th scope="col" class="text-center">
                                    <a asp-area="SystemAdmin" asp-controller="ManagerRole" asp-action="SystemAdmin"
                                       asp-route-sortOrder="@ViewData["RoleSortParam"]"
                                       asp-route-searchString="@ViewData["SearchString"]"
                                       asp-route-roleFilter="@ViewData["RoleFilter"]"
                                       class="text-dark text-decoration-none">
                                        <i class="bi bi-shield-lock me-1"></i>Vai trò
                                        @if (ViewData["SortOrder"]?.ToString() == "role_asc")
                                        {
                                            <i class="bi bi-sort-alpha-down"></i>
                                        }
                                        else if (ViewData["SortOrder"]?.ToString() == "role_desc")
                                        {
                                            <i class="bi bi-sort-alpha-up"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-arrow-down-up"></i>
                                        }
                                    </a>
                                </th>
                                <th scope="col" class="text-center">
                                    <i class="bi bi-gear me-1"></i>Thao tác
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int count = (pageNo - 1) * 9 + 1;
                            }
                            @foreach (dynamic user in Model)
                            {
                                <tr>
                                    <td class="text-center">@(count++)</td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold">@(user.FullName ?? "(Chưa cập nhật)")</span>
                                            <span class="text-muted small">
                                                <i class="bi bi-envelope-fill me-1"></i>@user.Email
                                            </span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        @foreach (string role in user.Roles)
                                        {
                                            string badgeClass = role.ToLower() switch
                                            {
                                                "admin" => "bg-danger",
                                                "manager" => "bg-warning text-dark",
                                                "seller" => "bg-info text-dark",
                                                "nutri" => "bg-success",
                                                _ => "bg-secondary"
                                            };
                                            <span class="badge @badgeClass me-1">@role</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a asp-area="SystemAdmin" asp-controller="ManagerRole" asp-action="Update" asp-route-id="@user.Id"
                                               class="btn btn-sm btn-outline-primary"
                                               data-bs-toggle="tooltip" title="Chỉnh sửa">
                                                <i class="bi bi-pencil-square"></i>
                                            </a>
                                            <a asp-area="SystemAdmin" asp-controller="ManagerRole" asp-action="Delete" asp-route-id="@user.Id"
                                               class="btn btn-sm btn-outline-danger"
                                               data-bs-toggle="tooltip" title="Xóa">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Phân trang -->
                @if (pager.TotalPages > 0)
                {
                    <div class="mt-4">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                                @if (pager.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link"
                                           asp-area="SystemAdmin"
                                           asp-controller="ManagerRole"
                                           asp-action="SystemAdmin"
                                           asp-route-pg="1"
                                           asp-route-searchString="@ViewData["SearchString"]"
                                           asp-route-roleFilter="@ViewData["RoleFilter"]">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link"
                                           asp-area="SystemAdmin"
                                           asp-controller="ManagerRole"
                                           asp-action="SystemAdmin"
                                           asp-route-pg="@(pager.CurrentPage - 1)"
                                           asp-route-searchString="@ViewData["SearchString"]"
                                           asp-route-roleFilter="@ViewData["RoleFilter"]">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                }

                                @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                {
                                    <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                        <a class="page-link"
                                           asp-area="SystemAdmin"
                                           asp-controller="ManagerRole"
                                           asp-action="SystemAdmin"
                                           asp-route-pg="@pge"
                                           asp-route-searchString="@ViewData["SearchString"]"
                                           asp-route-roleFilter="@ViewData["RoleFilter"]">@pge</a>
                                    </li>
                                }

                                @if (pager.CurrentPage < pager.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link"
                                           asp-area="SystemAdmin"
                                           asp-controller="ManagerRole"
                                           asp-action="SystemAdmin"
                                           asp-route-pg="@(pager.CurrentPage + 1)"
                                           asp-route-searchString="@ViewData["SearchString"]"
                                           asp-route-roleFilter="@ViewData["RoleFilter"]">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link"
                                           asp-area="SystemAdmin"
                                           asp-controller="ManagerRole"
                                           asp-action="SystemAdmin"
                                           asp-route-pg="@(pager.TotalPages)"
                                           asp-route-searchString="@ViewData["SearchString"]"
                                           asp-route-roleFilter="@ViewData["RoleFilter"]">
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Khởi tạo tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
}

